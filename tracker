import pandas as pd
import selenium.webdriver as webdriver
from selenium.webdriver.firefox.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException
import re
from selenium.webdriver.common.by import By
#import choix_fournisseur #AF: quand on aura le fichier choix_fournisseur.py pour g√©rer les choix de fournisseurs √† tracker


class GeneralTracker:

    def __init__(self):
        #Parametrages Selenium
        options = Options()
        #options.add_argument("--headless")  #AF: d√©commenter pour ex√©cuter en mode headless (sans interface graphique)
        self.driver = webdriver.Firefox(options=options)
        
        # AF : mettre en place des temps d'attente explicite pour le chargement des √©l√©ments
        self.wait = WebDriverWait(self.driver, 5)

        #Sauvegarde des donn√©es extraites au fil des extractions
        self.data = []
        
        #Pour la version tester, on va tracker seulement Sysco:
        self.sysco()
        self.save_to_csv()

    def find_pass_layout (self):
        try:
            more_button = self.find("//button[@class='load-more-button']")
            next_button = self.find("//a[@class='next-page']")
            if more_button.is_displayed():
                get_next_page = more_button.click()
                return 'more'
            elif next_button.is_displayed():
                get_next_page = next_button.click()
                return 'next'
        except:
            return 'end'

    def extract_product_data(self, product_element):
        """
        Extrait les donn√©es d'un √©l√©ment de produit donn√©.
        """
        data = {
            'designation': None,
            #AF : 'label': None,
            'reference': None,
            'url_product': None
        }

        # --- URL ---
        try:
            data['url_product'] = product_element.find_element(
                By.XPATH, ".//a[@href]"
            ).get_attribute("href")
        except:
            pass

        # --- DESIGNATION ---
        try:
            designation_elem = product_element.find_element(
                By.XPATH,
                ".//*[self::h1 or self::h2 or self::h3 or self::span or self::div][string-length(normalize-space(text())) > 15]"
            )
            data['designation'] = designation_elem.text.strip()
        except:
            pass

        # --- REFERENCE ---
        try:
            ref_elem = product_element.find_element(
                By.XPATH,
                ".//*[contains(text(),'R√©f') or contains(text(),'R√©f√©rence') or string-length(normalize-space(text())) < 10]"
            )
            raw_ref = ref_elem.text.strip()
            match = re.search(r'\d+', raw_ref)
            if match:
                data['reference'] = match.group()
        except:
            pass

        return data

    def sysco(self):
        self.driver.get("https://shop.sysco.fr/Produits/c/produits?q=%3AnumeroOrdreTarif&text=&mode=0&page=1")
        while True:
            products = self.driver.find_elements(By.XPATH, "//div[contains(@class, 'product-row')]")
            for product in products:
                product_data = self.extract_product_data(product)
                product_data["Fournisseur"] = "Sysco"
                self.data.append(product_data)
            if self.find_pass_layout () != 'end':
                get_next_page = self.find_pass_layout ()
                return True
            else:
                break


    #AF: adapter la function extract_product_data pour chaque fournisseur
    '''Pomona Terre Azur ‚Üí div.ms-product-inner
    Pro a Pro ‚Üí product_card
    Metro ->
    Transgourmet -> 
    Vivalya ->
    Promocash -> '''

    def save_to_csv(self, filename='donnees_fournisseur.csv'):
            """Sauvegarde les donn√©es extraites dans un fichier CSV."""
            df = pd.DataFrame(self.data)
            df.to_csv(filename, sep=';', index=False)
            print(f"üíæ Donn√©es sauvegard√©es dans '{filename}'")


    def effacer_donnees_csv(self, filename='donnees_fournisseur.csv'):
        """Efface le contenu du fichier CSV."""
        df = pd.DataFrame(columns=['D√©signation', 'Code R√©f√©rence', 'Fournisseur', 'URL Produit'])
        df.to_csv(filename, sep=';', index=False)
        print(f"üóëÔ∏è Contenu de '{filename}' effac√©.")